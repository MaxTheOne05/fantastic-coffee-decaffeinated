openapi: 3.0.0




info:
  title: WASAText API
  description: |
    WASAText is a PC based messaging platform that allows 
    users to communicate with contacts and groups.
  version: 3.0.0




tags:
  - name: login
    description: Operations related to user authentication and session management.
  - name: user
    description: Operations related to user profile management.




servers:
  - url: http://localhost:3000




components:

  securitySchemes:
    bearerAuth:
      description: |
        Simplified bearer authentication used for the course project.
        The "token" is NOT a JWT: it is the user identifier (UUID) returned by /auth/login.
        Clients must send this value in the Authorization header:
        Authorization: Bearer <userId>
        NOTE: No signature verification or standard IdP flows are performed in this project.
      type: http
      scheme: bearer
      bearerFormat: user-id

  headers:
    WWW-Authenticate:
      description: 'Authentication method required (Bearer).'
      schema:
        type: string
      example: 'Bearer realm="WASAText", error="invalid_token", error_description="Provide userId as bearer token"'
  
  schemas:

    # ERRORS
    Error:
      type: object
      properties:
        
        code:
          description: A machine-readable error code.
          type: string
          pattern: "^[A-Z_]+$"
          minLength: 1
          maxLength: 20
          example: "AUTH_FAILED"
        
        message:
          description: A human-readable message providing more details about the error.
          type: string
          pattern: "^[\\s\\S]*$"
          minLength: 0
          maxLength: 1000
          example: "Missing or invalid access token."
        
        details:
          description: Additional details about the error (optional).
          type: object
          nullable: true
          
      
      required:
        - code
        - message


    # IDENTIFIERS
    Id:
      description: Generic UUID identifier used as base for domain IDs.
      type: string
      format: uuid
      pattern: "^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$"
      minLength: 36
      maxLength: 36
      example: "123e4567-e89b-12d3-a456-426614174000"

    UserId:
      description: "Identifier for a user (alias of Id)."
      allOf:
        - $ref: '#/components/schemas/Id'
      example: "123e4567-e89b-12d3-a456-426614174000"

    MessageId:
      description: "Identifier for a message (alias of Id)."
      allOf:
        - $ref: '#/components/schemas/Id'
      example: "323e4567-e89b-12d3-a456-426614174002"

    ConversationId:
      description: "Identifier for a conversation (alias of Id)."
      allOf:
        - $ref: '#/components/schemas/Id'
      example: "223e4567-e89b-12d3-a456-426614174001"


    # USER
    Username:
      description: The username of the user.
      type: string
      pattern: "^[a-zA-Z0-9_]{3,16}$"
      minLength: 3
      maxLength: 16
      example: "johndoe"


    UserPhotoUrl:
      description: A URL pointing to the user's profile photo.
      allOf:
        - $ref: '#/components/schemas/PhotoUrl'
      example: "http://example.com/photos/johndoe.jpg"

    User:
      description: A user in the WASAText system.
      type: object
      properties:

        userId:
          $ref: '#/components/schemas/UserId'
        
        username:
          $ref: '#/components/schemas/Username'
        
        photoUrl:
          $ref: '#/components/schemas/UserPhotoUrl'

      required:
        - userId 
        - username

    
    # CONVERSATION
    Chat:
      description: A chat conversation, between two users.
      type: object
      properties:
        
        conversationId:
          $ref: '#/components/schemas/ConversationId'
        
        participantIds:
          description: List of user IDs participating in the chat (exactly 2 for direct chats).
          type: array
          minItems: 2
          maxItems: 2
          items:
            $ref: '#/components/schemas/UserId'
      
      required:
        - conversationId
        - participantIds

    Group:
      description: A group conversation, between multiple users.
      type: object
      properties:

        conversationId:
          $ref: '#/components/schemas/ConversationId'
        
        name:
          description: The name of the group.
          type: string
          pattern: "^[\\s\\S]{1,100}$"
          minLength: 1
          maxLength: 100
          example: "Family Group"
        
        photoUrl:
          $ref: '#/components/schemas/PhotoUrl'
       
        memberIds:
          description: List of user IDs who are members of the group.
          type: array
          minItems: 1
          maxItems: 1000
          items:
            $ref: '#/components/schemas/UserId'
      
      required:
        - conversationId
        - name
        - memberIds

    Conversation:
      description: A conversation, which can be either a chat or a group.
      type: object
      oneOf:
        - $ref: '#/components/schemas/Chat'
        - $ref: '#/components/schemas/Group'

    
    # CONTENT TYPES
    PhotoUrl:
      description: A URL pointing to a photo image.
      type: string
      format: uri
      pattern: "^(https?|ftp)://.+$"
      minLength: 1
      maxLength: 1000
      example: "http://example.com/photos/johndoe.jpg"


    Text:
      description: A block of text.
      type: string
      pattern: "^[\\s\\S]{0,1000}$"
      minLength: 0
      maxLength: 1000
      example: "Hello, this is a message."


    # MESSAGE
    MessagePhotoUrl:
      description: A URL pointing to a photo attached to a message.
      allOf:
        - $ref: '#/components/schemas/PhotoUrl'
      example: "http://example.com/messages/photos/photo123.jpg"

    Message:
      description: The type of a message.
      type: object
      properties:

        messageId:
          $ref: '#/components/schemas/MessageId'
        
        conversationId:
          $ref: '#/components/schemas/ConversationId'
        
        senderId:
          $ref: '#/components/schemas/UserId'
        
        createdAt:
          description: Timestamp when the message was created.
          type: string
          format: date-time
          pattern: "^[0-9T:\\-+\\.Z]+$"
          minLength: 20
          maxLength: 20
          example: "2024-01-01T12:00:00Z"
        
        content:
          description: The content of the message, could be text and/or photo URL.
          type: object
          properties:
            text:
              $ref: '#/components/schemas/Text'
            photoUrl:
              $ref: '#/components/schemas/MessagePhotoUrl'
          additionalProperties: false
          minProperties: 1
          maxProperties: 2
        
        status:
          description: The status of the message.
          type: string
          pattern: "^(sent|read)$"
          minLength: 4
          maxLength: 4
          enum:
            - sent
            - read
          example: "sent"
      
      required:
        - messageId
        - conversationId
        - senderId
        - createdAt
        - content
        - status
              

    # REACTION
    ReactionId:
      description: The unique identifier of a reaction.
      type: string
      format: uuid
      pattern: "^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$"
      minLength: 36
      maxLength: 36
      example: "423e4567-e89b-12d3-a456-426614174003"
    
    Reaction:
      description: A reaction to a message.
      type: object
      properties:
        
        reactionId:
          $ref: '#/components/schemas/ReactionId'
        
        messageId:
          $ref: '#/components/schemas/MessageId'
        
        userId:
          $ref: '#/components/schemas/UserId'
        
        emoji:
          description: The emoji used for the reaction.
          type: string
          pattern: "^[\\s\\S]{1,4}$"
          minLength: 1
          maxLength: 5
          example: "1F44D" #ðŸ‘
        
        reactedAt:
          description: Timestamp when the reaction was made.
          type: string
          format: date-time
          pattern: "^[0-9T:\\-+\\.Z]+$"
          minLength: 20
          maxLength: 20
          example: "2024-01-01T12:02:00Z"

      required:
        - reactionId
        - messageId
        - userId
        - emoji
        - reactedAt




  responses:
    Unauthorized:
      description: Unauthorized - missing or invalid user identifier in Authorization header.
      headers:
        WWW-Authenticate:
          $ref: '#/components/headers/WWW-Authenticate'
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          examples:
            missing_token:
              summary: Missing or invalid user identifier
              value:
                code: "AUTH_MISSING_USERID"
                message: "Missing or invalid user identifier in Authorization header."
                details: null

    
    Forbidden:
      description: Forbidden - authenticated but not allowed to access this resource.
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          examples:
            not_allowed:
              summary: Access forbidden
              value:
                code: "AUTH_FORBIDDEN"
                message: "You do not have permission to access this resource."
                details: null

    BadRequest:
      description: Bad Request - invalid input.
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          examples:
            invalid_input:
              summary: Invalid input data
              value:
                code: "INVALID_INPUT"
                message: "The provided input data is invalid."
                details:
                  field_errors:
                    username: "Username must be at least 3 characters long."

    Conflict:
      description: Conflict - username not allowed or other business conflict.
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          examples:
            resource_already_exists:
              summary: Resource already exists
              value:
                code: "RESOURCE_CONFLICT"
                message: "The username is already taken."
                details: null

    TooManyRequests:
      description: Too Many Requests - rate limit exceeded.
      headers:
        Retry-After:
          description: Seconds to wait before retrying.
          schema:
            type: integer
          example: 60
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          examples:
            rate_limit_exceeded:
              summary: Rate limit exceeded
              value:
                code: "RATE_LIMIT_EXCEEDED"
                message: "You have exceeded the number of allowed requests. Please try again later."
                details: null

    InternalError:
      description: Internal Server Error.
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          examples:
            internal_server_error:
              summary: Internal server error
              value:
                code: "INTERNAL_SERVER_ERROR"
                message: "An unexpected error occurred. Please try again later."
                details: null
    
    NotFound:
      description: Not Found - resource does not exist.
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          examples:
            resource_not_found:
              summary: Resource not found
              value:
                code: "RESOURCE_NOT_FOUND"
                message: "The requested resource was not found."
                details: null

    PayloadTooLarge:
      description: Payload Too Large - uploaded file exceeds size limit.
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          examples:
            payload_too_large:
              summary: Uploaded file too large
              value:
                code: "PAYLOAD_TOO_LARGE"
                message: "The uploaded file exceeds the maximum allowed size."
                details: null

    UnsupportedMediaType:
      description: Unsupported Media Type - uploaded file type is not supported.
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          examples:
            unsupported_media_type:
              summary: Uploaded file type not supported
              value:
                code: "UNSUPPORTED_MEDIA_TYPE"
                message: "The uploaded file type is not supported."
                details: null




security:
  - bearerAuth: []




paths:

  # LOGIN
  /session:
    post:
      tags: ["login"]
      summary: logs in the user
      description: |-
        If the user does not exist, it will be created,
        and an identifier is returned.
        If the user exists, the user identifier is returned.
      operationId: doLogin
      requestBody:
        description: User details.
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                username:
                  $ref: "#/components/schemas/Username"
      responses:
        '200':
          description: Login successful.
          content:
            application/json:
              schema:
                type: object
                properties:
                  userId:
                    $ref: "#/components/schemas/UserId"
        '201':
          description: User created and login successful.
          content:
            application/json:
              schema:
                type: object
                properties:
                  userId:
                    $ref: "#/components/schemas/UserId"
        '400':
          $ref: '#/components/responses/BadRequest'
        '409':
          $ref: '#/components/responses/Conflict'
        '429':
          $ref: '#/components/responses/TooManyRequests'
        '500':
          $ref: '#/components/responses/InternalError'


  # SET USER PROFILE
  /me/username:
    patch:
      tags: ["user"]
      summary: Sets my username
      description: Sets the authenticated user's username.
      operationId: setMyUserName
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/Username"
      responses:
        '200':
          description: Username set successfully.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/User"
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '409':
          $ref: '#/components/responses/Conflict'
        '500':
          $ref: '#/components/responses/InternalError'

  /me/photo:
    patch:
      tags: ["user"]
      summary: Sets my profile photo URL
      description: Sets the authenticated user's profile photo URL.
      operationId: setMyPhoto
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/PhotoUrl"
      responses:
        '200':
          description: Profile photo URL set successfully.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/User"
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '500':
          $ref: '#/components/responses/InternalError'


  # SEARCH USER BY USERNAME
  /users:
    get:
      tags: ["user"]
      summary: Search users by username.
      description: | 
        Searches for users whose usernames match the provided query.
      operationId: searchUser
      parameters:
        - name: username
          description: The username to search for (full match).
          in: query
          required: true
          schema:
            $ref: '#/components/schemas/Username'
      responses:
        '200':
          description: The user matching the exact username. Null if not found.
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/User'
                nullable: true
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '500':
          $ref: '#/components/responses/InternalError'




#TOCHECK


  /conversations/{conversationId}/messages:
    post:
      summary: Send a message
      description: Sends a message in the specified conversation.
      operationId: sendMessage
      parameters:
        - name: conversationId
          in: path
          required: true
          schema:
            $ref: '#/components/schemas/ConversationId'
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                # bisognera stabilire delle regole di validazione lato server per i campi in base al tipo di messaggio
                type:
                  $ref: '#/components/schemas/MessageType'
                text:
                  description: Text content of the message (for text and text_with_photo types).
                  type: string
                  pattern: "^[\\s\\S]*$"
                  minLength: 0
                  maxLength: 1000
                  example: "Hello, this is a message with a photo." 
                photo:
                  description: Image file. Server will upload it and set content.photoUrl in the returned Message.
                  type: string
                  format: binary
                  pattern: "^[\\s\\S]*$"
                  minLength: 1
                  maxLength: 10485760 # 10 MB
                forwardedMessageId:
                  $ref: '#/components/schemas/MessageId'
                replyToMessageId:
                  $ref: '#/components/schemas/MessageId'
                clientMessageId: # SarÃ  unico per ogni messaggio inviato dal client serve per evitare che un messaggio venga inviato piÃ¹ volte in caso di retry
                  description: Client-generated id for idempotency (recommend UUID v4)
                  type: string
                  pattern: "^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$"
                  minLength: 36
                  maxLength: 36
                  example: "523e4567-e89b-12d3-a456-426614174004"
              required:
                - type
      responses:
        '200':
          description: Returned when clientMessageId already exists for (conversationId,senderId); no new message created.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Message'
        '201':
          description: Message sent successfully.
          headers:
            Location:
              description: URL of the newly created message resource.
              schema:
                description: URL of the newly created message resource.
                type: string
                format: uri
                pattern: "^(https?|ftp)://[^\\s/$.?#].[^\\s]*$"
                minLength: 0
                maxLength: 1000
                example: "http://localhost:3000/conversations/223e4567-e89b-12d3-a456-426614174001/messages/323e4567-e89b-12d3-a456-426614174002"
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Message'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '413':
          $ref: '#/components/responses/PayloadTooLarge'
        '415':
          $ref: '#/components/responses/UnsupportedMediaType'
        '429':
          $ref: '#/components/responses/TooManyRequests'
        '500':
          $ref: '#/components/responses/InternalError'

  /conversations/{conversationId}/messages/{messageId}:
    delete:
      summary: Delete a message
      description: |
        Delete a message previously sent by the authenticated user in the specified conversation.
        Only the original sender of the message may delete it. The operation is idempotent:
        calling DELETE multiple times for the same message will still return 204 No Content.
        After deletion the server should mark the message as deleted (e.g. `deleted: true`)
        so clients can render a "message deleted" placeholder if desired.
      operationId: deleteMessage
      parameters:
        - name: conversationId
          in: path
          required: true
          description: Conversation identifier where the message was posted.
          schema:
            $ref: '#/components/schemas/ConversationId'
        - name: messageId
          in: path
          required: true
          description: Identifier of the message to delete.
          schema:
            $ref: '#/components/schemas/MessageId'
      responses:
        '204':
          description: Message deleted successfully (or already deleted). No content returned.
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '429':
          $ref: '#/components/responses/TooManyRequests'
        '500':
          $ref: '#/components/responses/InternalError'

  /messages/{messageId}/forward:
    post:
      summary: Forward a message to one or more destinations
      description: |
        Forward the specified message to one or more destinations. A destination can be an
        existing conversation (conversationId) or a single user (userId). When forwarding to
        a user, the server will create or reuse a direct conversation between the authenticated
        user and that user. Idempotenza per-destinazione se il client fornisce clientMessageId.
      operationId: forwardMessage
      parameters:
        - name: messageId
          in: path
          required: true
          description: Identifier of the message to forward.
          schema:
            $ref: '#/components/schemas/MessageId'
      requestBody:
        description: Forward request specifying destinations and optional comment.
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                destinations:
                  description: |
                    Array di destinazioni. Ogni elemento deve contenere **exactly one** di
                    conversationId o userId. clientMessageId Ã¨ opzionale e serve per idempotenza.
                  type: array
                  minItems: 1
                  maxItems: 1000
                  items:
                    type: object
                    properties:
                      conversationId:
                        $ref: '#/components/schemas/ConversationId'
                      userId:
                        $ref: '#/components/schemas/UserId'
                      clientMessageId:
                        description: Client-generated id for idempotency (recommend UUID v4)
                        type: string
                        format: uuid
                        pattern: "^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$"
                        minLength: 36
                        maxLength: 36
                        example: "623e4567-e89b-12d3-a456-426614174005"
                    additionalProperties: false
                comment:
                  description: Optional comment to include with the forwarded message.
                  type: string
                  pattern: "^[\\s\\S]*$"
                  minLength: 0
                  maxLength: 1000
                  example: "Check this out!"
                includeMedia:
                  description: Whether to include attached media (photo) when present.
                  type: boolean
                  default: true
              required:
                - destinations
      responses:
        '201':
          description: One or more messages created for the specified destinations.
          content:
            application/json:
              schema:
                type: object
                properties:
                  created:
                    description: List of created messages and their actual destination.
                    type: array
                    minItems: 1
                    maxItems: 1000
                    items:
                      type: object
                      properties:
                        destination:
                          type: object
                          properties:
                            conversationId:
                              $ref: '#/components/schemas/ConversationId'
                            userId:
                              $ref: '#/components/schemas/UserId'
                        message:
                          $ref: '#/components/schemas/Message'
                        clientMessageId:
                          description: The clientMessageId provided by the client for idempotency, if any.
                          type: string
                          format: uuid
                          pattern: "^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$"
                          minLength: 36
                          maxLength: 36
                          example: "623e4567-e89b-12d3-a456-426614174005"
                      required:
                        - destination
                        - message
        '200':
          description: No new messages created (all forwards were idempotent / skipped).
          content:
            application/json:
              schema:
                type: object
                properties:
                  created:
                    description: Empty if none created.
                    type: array
                    minItems: 0
                    maxItems: 1000
                    items:
                      $ref: '#/components/schemas/Message'
                  skipped:
                    type: array
                    minItems: 0
                    maxItems: 1000
                    items:
                      description: Destinazioni saltate con motivo (es. duplicate clientMessageId).
                      type: object
                      properties:
                        destination:
                          type: object
                          properties:
                            conversationId:
                              $ref: '#/components/schemas/ConversationId'
                            userId:
                              $ref: '#/components/schemas/UserId'
                        reason:
                          description: Reason why the forward was skipped for this destination.
                          type: string
                          pattern: "^[\\s\\S]*$"
                          minLength: 1
                          maxLength: 1000
                          example: "Duplicate clientMessageId"
                      
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          $ref: '#/components/responses/Conflict'
        '413':
          $ref: '#/components/responses/PayloadTooLarge'
        '429':
          $ref: '#/components/responses/TooManyRequests'
        '500':
          $ref: '#/components/responses/InternalError'

  /conversations/{conversationId}/messages/{messageId}/comments:
    post:
      summary: Add a reaction (comment) to a message
      description: |
        Add a reaction (emoticon) to the specified message. If the authenticated user
        already reacted to the message with the same emoji, the operation is idempotent
        and the existing reaction is returned with 200 OK. Otherwise a new Reaction is
        created and returned with 201 Created.
      operationId: commentMessage
      parameters:
        - name: conversationId
          description: Conversation identifier containing the message.
          in: path
          required: true
          schema:
            $ref: '#/components/schemas/ConversationId'
        - name: messageId
          description: Identifier of the message to react to.
          in: path
          required: true
          schema:
            $ref: '#/components/schemas/MessageId'
      requestBody:
        description: Reaction to add to the message.
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                emoji:
                  description: The emoji to use for the reaction (single emoji, 1â€“4 UTF-8 codepoints).
                  type: string
                  pattern: "^[\\s\\S]{1,4}$"
                  minLength: 1
                  maxLength: 4
                  example: "ðŸ‘"
              required:
                - emoji
      responses:
        '201':
          description: Reaction created successfully.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Reaction'
        '200':
          description: Reaction already existed for this user+emoji; returning existing reaction.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Reaction'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          $ref: '#/components/responses/Conflict'
        '429':
          $ref: '#/components/responses/TooManyRequests'
        '500':
          $ref: '#/components/responses/InternalError'

  /conversations/{conversationId}/messages/{messageId}/comments/{emoji}:
    delete:
      summary: Remove a reaction (comment) from a message
      description: |
        Remove the authenticated user's reaction from the specified message.
        The operation is idempotent: if the reaction exists, it is removed and returned
        with 200 OK; if no such reaction exists, 204 No Content is returned.
      operationId: uncommentMessage
      parameters:
        - name: conversationId
          description: Conversation identifier containing the message.
          in: path
          required: true
          schema:
            $ref: '#/components/schemas/ConversationId'

        - name: messageId
          description: Identifier of the message whose reaction will be removed.
          in: path
          required: true
          schema:
            $ref: '#/components/schemas/MessageId'

        - name: emoji
          in: path
          required: true
          description: Emoji of the reaction to remove.
          schema:
            type: string
            pattern: "^[\\s\\S]{1,4}$"
            minLength: 1
            maxLength: 4
            example: "ðŸ‘"

      responses:
        '200':
          description: Reaction found and removed successfully.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Reaction'

        '204':
          description: No reaction existed for this user+emoji; nothing to remove.

        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '429':
          $ref: '#/components/responses/TooManyRequests'
        '500':
          $ref: '#/components/responses/InternalError'

  /me/conversations:
    get:
      summary: Get my conversations (list)
      description: >
        Return the list of conversations (direct or group) of the authenticated user,
        sorted in reverse chronological order (most recent activity first).
        Each element contains the conversation id, name, photoUrl, lastMessage snippet,
        lastActivity timestamp and unreadCount. Pagination supported via `limit` and `before`.
      operationId: getMyConversations
      parameters:
        - name: limit
          in: query
          required: false
          description: Maximum number of conversations to return (pagination).
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 25
        - name: before
          in: query
          required: false
          description: Return conversations with lastActivity strictly before this timestamp (ISO 8601 UTC). Use for cursor-style pagination.
          schema:
            type: string
            format: date-time
            pattern: "^[0-9]{4}-[0-9]{2}-[0-9]{2}T[0-9]{2}:[0-9]{2}:[0-9]{2}Z$"
            minLength: 20
            maxLength: 20
            example: "2025-11-16T12:00:00Z"
        - name: q
          in: query
          required: false
          description: Optional search query to filter conversations by participant username or conversation name (substring match).
          schema:
            type: string
            pattern: "^[\\s\\S]{0,100}$"
            minLength: 0
            maxLength: 100
            example: "maria"
        - name: unreadOnly
          in: query
          required: false
          description: If true, return only conversations with unread messages.
          schema:
            type: boolean
            default: false
      responses:
        '200':
          description: A page of conversations.
          content:
            application/json:
              schema:
                type: object
                properties:
                  conversations:
                    description: Array of conversation summaries ordered by lastActivity desc.
                    type: array
                    minItems: 0
                    maxItems: 100
                    items:
                      $ref: '#/components/schemas/ConversationSummary'
                  totalCount:
                    description: Total number of conversations (may be approximate for performance).
                    type: integer
                    minimum: 0
                    example: 42
                  nextBefore:
                    description: | 
                      Cursor value (timestamp) to request the next page: use as `before` in the next call, or omitted/null if no more pages.
                    type: string
                    format: date-time
                    pattern: "^[0-9]{4}-[0-9]{2}-[0-9]{2}T[0-9]{2}:[0-9]{2}:[0-9]{2}Z$"
                    minLength: 20
                    maxLength: 20
                    nullable: true
                    example: "2025-11-15T08:30:00Z"
                required:
                  - conversations
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '429':
          $ref: '#/components/responses/TooManyRequests'
        '500':
          $ref: '#/components/responses/InternalError'

  /conversations/{conversationId}:
    get:
      summary: Get conversation messages
      description: |
        Return the conversation metadata and the list of messages for the specified conversation,
        ordered in reverse chronological order (most recent first). Supports cursor-style
        pagination using `before` (ISO 8601 UTC timestamp). Clients should pass `limit` to
        control page size. By default reactions and delivery/read statuses are included;
        can be disabled with query flags to reduce payload size.
      operationId: getConversation
      parameters:
        - name: conversationId
          in: path
          required: true
          description: Identifier of the conversation to retrieve.
          schema:
            $ref: '#/components/schemas/ConversationId'

        - name: limit
          in: query
          required: false
          description: Maximum number of messages to return in this page.
          schema:
            type: integer
            minimum: 1
            maximum: 200
            default: 50

        - name: before
          in: query
          required: false
          description: Return messages with createdAt strictly before this timestamp (ISO 8601 UTC, use as cursor). If omitted, the page starts from now (most recent).
          schema:
            type: string
            format: date-time
            pattern: "^[0-9]{4}-[0-9]{2}-[0-9]{2}T[0-9]{2}:[0-9]{2}:[0-9]{2}Z$"
            minLength: 20
            maxLength: 20
            example: "2025-11-16T12:00:00Z"

        - name: includeReactions
          in: query
          required: false
          description: If false, reactions will be omitted from the response to reduce payload.
          schema:
            type: boolean
            default: true

        - name: includeStatuses
          in: query
          required: false
          description: If false, delivery/read status information will be omitted from the response.
          schema:
            type: boolean
            default: true

      responses:
        '200':
          description: Conversation metadata and a page of messages.
          content:
            application/json:
              schema:
                type: object
                properties:
                  conversation:
                    $ref: '#/components/schemas/ConversationSummary'
                  messages:
                    description: Array of message entries in reverse chronological order (most recent first).
                    type: array
                    minItems: 0
                    maxItems: 200
                    items:
                      type: object
                      properties:
                        message:
                          $ref: '#/components/schemas/Message'
                        reactions:
                          description: Reactions attached to the message (may be empty or omitted if includeReactions=false).
                          type: array
                          minItems: 0
                          maxItems: 1000
                          items:
                            $ref: '#/components/schemas/Reaction'
                        statuses:
                          description: Delivery/read status entries for the message (may be empty or omitted if includeStatuses=false).
                          type: array
                          minItems: 0
                          maxItems: 1000
                          items:
                            $ref: '#/components/schemas/MessageStatus'
                      required:
                        - message
                  nextBefore:
                    description: | 
                      Cursor timestamp (ISO 8601 UTC) to fetch the next page: pass as `before` in the subsequent request. Null if no more messages.
                    type: string
                    format: date-time
                    pattern: "^[0-9]{4}-[0-9]{2}-[0-9]{2}T[0-9]{2}:[0-9]{2}:[0-9]{2}Z$"
                    minLength: 20
                    maxLength: 20
                    nullable: true
                    example: "2025-11-15T08:30:00Z"
                required:
                  - conversation
                  - messages
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '429':
          $ref: '#/components/responses/TooManyRequests'
        '500':
          $ref: '#/components/responses/InternalError'

  /groups/{groupId}/name:
    patch:
      summary: Set group name
      description: >
        Set or update the display name of a group. Only users with the group role "admin"
        may rename the group. Direct 1:1 conversations are not addressable via /groups.
        Returns the updated ConversationSummary for the group.
      operationId: setGroupName
      parameters:
        - name: groupId
          in: path
          required: true
          description: Identifier of the group conversation to rename (same format as ConversationId).
          schema:
            $ref: '#/components/schemas/ConversationId'
      requestBody:
        description: New group name.
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  description: New name for the group (1â€“100 characters).
                  type: string
                  pattern: "^[\\s\\S]{1,100}$"
                  minLength: 1
                  maxLength: 100
                  example: "Weekend Friends"
              required:
                - name
      responses:
        '200':
          description: Group renamed successfully; returns updated conversation summary.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConversationSummary'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          description: Forbidden - authenticated but not allowed (e.g., not admin or not a member).
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          $ref: '#/components/responses/Conflict'
        '429':
          $ref: '#/components/responses/TooManyRequests'
        '500':
          $ref: '#/components/responses/InternalError'

  /groups/{groupId}/photo:
    patch:
      summary: Set group photo
      description: >
        Set or update the group's photo. Only users with the group role "admin" may change the photo.
        Accepts multipart/form-data with a binary field named "photo". Returns the updated ConversationSummary.
      operationId: setGroupPhoto
      parameters:
        - name: groupId
          in: path
          required: true
          description: Identifier of the group conversation to update photo for.
          schema:
            $ref: '#/components/schemas/ConversationId'
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                photo:
                  type: string
                  format: binary
                  description: Image file to upload (server validates type/size). Max allowed size enforced server-side.
              required:
                - photo
      responses:
        '200':
          description: Group photo updated successfully; returns updated conversation summary.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConversationSummary'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          description: Forbidden - authenticated but not allowed (e.g., not admin or not a member).
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '413':
          $ref: '#/components/responses/PayloadTooLarge'
        '415':
          $ref: '#/components/responses/UnsupportedMediaType'
        '429':
          $ref: '#/components/responses/TooManyRequests'
        '500':
          $ref: '#/components/responses/InternalError'

  /groups/{groupId}/members:
    post:
      summary: Add one or more users to a group
      description: |
        Add the specified users to the group. Only existing group members may add other users.
        For each userId the server will try to add the user; already-member userIds are reported in "skipped".
      operationId: addToGroup
      parameters:
        - name: groupId
          in: path
          required: true
          description: Identifier of the group to which members will be added.
          schema:
            $ref: '#/components/schemas/ConversationId'
      requestBody:
        description: List of user IDs to add to the group.
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                userIds:
                  description: Array of user identifiers to add to the group.
                  type: array
                  minItems: 1
                  maxItems: 1000
                  items:
                    $ref: '#/components/schemas/UserId'
              required:
                - userIds
      responses:
        '200':
          description: Users processed. Returns the updated conversation summary and details about added/skipped users.
          content:
            application/json:
              schema:
                type: object
                properties:
                  conversation:
                    $ref: '#/components/schemas/ConversationSummary'
                  added:
                    description: List of userIds that were successfully added.
                    type: array
                    minItems: 0
                    maxItems: 1000
                    items:
                      $ref: '#/components/schemas/UserId'
                  skipped:
                    description: List of objects describing skipped userIds and reason.
                    type: array
                    minItems: 0
                    maxItems: 1000
                    items:
                      type: object
                      properties:
                        userId:
                          $ref: '#/components/schemas/UserId'
                        reason:
                          type: string
                          pattern: "^[\\s\\S]{1,200}$"
                          minLength: 1
                          maxLength: 200
                      required:
                        - userId
                        - reason
                required:
                  - conversation
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          $ref: '#/components/responses/Conflict'
        '429':
          $ref: '#/components/responses/TooManyRequests'
        '500':
          $ref: '#/components/responses/InternalError'
          
  /groups/{groupId}/members/me:
    delete:
      summary: Leave the group (current authenticated user)
      description: >
        The authenticated user leaves the specified group. If the user is not a member
        the operation is idempotent and returns 204 No Content.
      operationId: leaveGroup
      parameters:
        - name: groupId
          in: path
          required: true
          description: Identifier of the group to leave.
          schema:
            $ref: '#/components/schemas/ConversationId'
      responses:
        '200':
          description: Left the group and returns the updated conversation summary (if applicable).
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConversationSummary'
        '204':
          description: The user was not a member (or already left); nothing to do.
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '429':
          $ref: '#/components/responses/TooManyRequests'
        '500':
          $ref: '#/components/responses/InternalError'
