openapi: 3.0.0




info:
  title: WASAText API
  description: |
    WASAText is a PC based messaging platform that allows 
    users to communicate with contacts and groups.
  version: 3.0.0




tags:
  - name: login
    description: Operations related to user authentication and session management.
  - name: user
    description: Operations related to user profile management.
  - name: media
    description: Operations related to media uploads and management.
  - name: messages
    description: Operations related to sending, deleting, forwarding messages.
  - name: reactions
    description: Operations related to adding and removing reactions
  - name: groups
    description: Operations related to setting group name, group photo, adding and removing participants.
  - name: conversations
    description: Operations related to showing conversations and messages.


servers:
  - url: http://localhost:3000



components:

  securitySchemes:
    bearerAuth:
      description: |
        Simplified bearer authentication used for the course project.
        The "token" is NOT a JWT: it is the user identifier (UUID) returned by /auth/login.
        Clients must send this value in the Authorization header:
        Authorization: Bearer <userId>
        NOTE: No signature verification or standard IdP flows are performed in this project.
      type: http
      scheme: bearer
      bearerFormat: user-id

  headers:
    WWW-Authenticate:
      description: 'Authentication method required (Bearer).'
      schema:
        $ref: '#/components/schemas/UserId'
      example: "123e4567-e89b-12d3-a456-426614174000"

  schemas:

    # ERRORS
    Error:
      type: object
      properties:
        
        code:
          description: A machine-readable error code.
          type: string
          pattern: "^[A-Z_]+$"
          minLength: 1
          maxLength: 20
          example: "AUTH_FAILED"
        
        message:
          description: A human-readable message providing more details about the error.
          type: string
          pattern: "^.*$"
          minLength: 0
          maxLength: 1000
          example: "Missing or invalid access token."
        
        details:
          description: Additional details about the error (optional).
          type: object
          nullable: true

      additionalProperties: false
             
      required:
        - code
        - message


    # IDENTIFIERS
    Id:
      description: Generic UUID identifier used as base for domain IDs.
      type: string
      format: uuid
      pattern: "^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$"
      minLength: 36
      maxLength: 36
      example: "123e4567-e89b-12d3-a456-426614174000"

    UserId:
      description: "Identifier for a user (alias of Id)."
      allOf:
        - $ref: '#/components/schemas/Id'
      example: "123e4567-e89b-12d3-a456-426614174000"

    MessageId:
      description: "Identifier for a message (alias of Id)."
      allOf:
        - $ref: '#/components/schemas/Id'
      example: "323e4567-e89b-12d3-a456-426614174002"

    ConversationId:
      description: "Identifier for a conversation (alias of Id)."
      allOf:
        - $ref: '#/components/schemas/Id'
      example: "223e4567-e89b-12d3-a456-426614174001"

    ReactionId:
      description: "Identifier for a reaction."
      allOf:
        - $ref: '#/components/schemas/Id'
      example: "223e4567-e89b-12d3-a456-426614174001"


    # USER
    Username:
      description: The username of the user.
      type: string
      pattern: "^[a-zA-Z0-9_]{3,16}$"
      minLength: 3
      maxLength: 16
      example: "johndoe"

    User:
      description: A user in the WASAText system.
      type: object
      properties:

        userId:
          $ref: '#/components/schemas/UserId'
        
        username:
          $ref: '#/components/schemas/Username'
        
        photoUrl:
          $ref: '#/components/schemas/PhotoUrl'

      additionalProperties: false

      required:
        - userId 
        - username

    
    # CONVERSATION
    PrivateChat:
      description: A private chat is conversation, between two users.
      type: object
      properties:
        
        conversationId:
          $ref: '#/components/schemas/ConversationId'
        
        participantIds:
          description: List of user IDs participating in the chat (exactly 2 for direct chats).
          type: array
          minItems: 2
          maxItems: 2
          items:
            $ref: '#/components/schemas/UserId'

      additionalProperties: false
      
      required:
        - conversationId
        - participantIds

    GroupName:
      description: The name of the group.
      type: string
      pattern: "^.*$"
      minLength: 1
      maxLength: 100
      example: "Family Group"

    Group:
      description: A group conversation, between multiple users.
      type: object
      properties:

        conversationId:
          $ref: '#/components/schemas/ConversationId'
        
        name:
          $ref: '#/components/schemas/GroupName'
        
        photoUrl:
          $ref: '#/components/schemas/PhotoUrl'
       
        memberIds:
          description: List of user IDs who are members of the group.
          type: array
          minItems: 0
          maxItems: 1000
          items:
            $ref: '#/components/schemas/UserId'

      additionalProperties: false
      
      required:
        - conversationId
        - name
        - memberIds

    Conversation:
      description: A conversation, which can be either a private chat or a group.
      type: object
      oneOf:
        - $ref: '#/components/schemas/PrivateChat'
        - $ref: '#/components/schemas/Group'


    # DATA TYPES
    Photo:
      type: string
      description: Binary photo file uploaded via multipart/form-data.
      format: binary
      minLength: 1
      maxLength: 50000000   # 50 MB, puoi cambiare
      pattern: "^.*$"
      example: ""  # gli esempi non sono realmente significativi per un binary

    PhotoUrl:
      description: A URL pointing to a photo image.
      type: string
      format: uri
      pattern: "^(https?|ftp)://.+$"
      minLength: 1
      maxLength: 1000
      example: "http://example.com/photos/johndoe.jpg"

    Text:
      description: A block of text.
      type: string
      pattern: "^.*$"
      minLength: 0
      maxLength: 1000
      example: "Hello, this is a message."

    Timestamp:
      description: Timestamp when the message was created.
      type: string
      format: date-time
      pattern: "^[0-9T:\\-+\\.Z]+$"
      minLength: 20
      maxLength: 25
      example: "2024-01-01T12:00:00Z"


    # MESSAGE
    MessageStatus:
      description: The status of the message.
      type: string
      pattern: "^(sent|read)$"
      minLength: 4
      maxLength: 4
      enum:
        - sent
        - read
      example: "sent"

    Message:
      description: The type of a message.
      type: object
      properties:

        messageId:
          $ref: '#/components/schemas/MessageId'
        
        conversationId:
          $ref: '#/components/schemas/ConversationId'
        
        senderId:
          $ref: '#/components/schemas/UserId'
        
        createdAt:
          $ref: '#/components/schemas/Timestamp'
        
        content:
          description: The content of the message, could be text and/or photo URL.
          type: object
          properties:
            text:
              $ref: '#/components/schemas/Text'
            photoUrl:
              $ref: '#/components/schemas/PhotoUrl'
          additionalProperties: false
          minProperties: 1
          maxProperties: 2
        
        status:
          $ref: '#/components/schemas/MessageStatus'

        replyTo:
          $ref: '#/components/schemas/MessageId'
          nullable: true

      additionalProperties: false

      required:
        - messageId
        - conversationId
        - senderId
        - createdAt
        - content
        - status
              

    # REACTION

    Emoji:
      type: string
      description: The emoji used for the reaction. Representation can be a short name, codepoint or emoji glyph.
      pattern: "^.*$"
      minLength: 1
      maxLength: 5
      example: "1F44D"
    
    Reaction:
      description: A reaction to a message.
      type: object
      properties:
        
        reactionId:
          $ref: '#/components/schemas/ReactionId'
        
        messageId:
          $ref: '#/components/schemas/MessageId'
        
        userId:
          $ref: '#/components/schemas/UserId'
        
        emoji:
          $ref: '#/components/schemas/Emoji'
        
        reactedAt:
          $ref: '#/components/schemas/Timestamp'
      
      additionalProperties: false

      required:
        - reactionId
        - messageId
        - userId
        - emoji
        - reactedAt




  responses:
   
    Unauthorized:
      description: Unauthorized - missing or invalid user identifier in Authorization header.
      headers:
        WWW-Authenticate:
          $ref: '#/components/headers/WWW-Authenticate'
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          examples:
            missing_token:
              summary: Missing or invalid user identifier
              value:
                code: "AUTH_MISSING_USERID"
                message: "Missing or invalid user identifier in Authorization header."
                details: null

    
    Forbidden:
      description: Forbidden - authenticated but not allowed to access this resource.
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          examples:
            not_allowed:
              summary: Access forbidden
              value:
                code: "AUTH_FORBIDDEN"
                message: "You do not have permission to access this resource."
                details: null

    BadRequest:
      description: Bad Request - invalid input.
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          examples:
            invalid_input:
              summary: Invalid input data
              value:
                code: "INVALID_INPUT"
                message: "The provided input data is invalid."
                details:
                  field_errors:
                    username: "Username must be at least 3 characters long."

    Conflict:
      description: Conflict - username not allowed or other business conflict.
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          examples:
            resource_already_exists:
              summary: Resource already exists
              value:
                code: "RESOURCE_CONFLICT"
                message: "The username is already taken."
                details: null

    TooManyRequests:
      description: Too Many Requests - rate limit exceeded.
      headers:
        Retry-After:
          description: Seconds to wait before retrying.
          schema:
            type: integer
          example: 60
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          examples:
            rate_limit_exceeded:
              summary: Rate limit exceeded
              value:
                code: "RATE_LIMIT_EXCEEDED"
                message: "You have exceeded the number of allowed requests. Please try again later."
                details: null

    InternalError:
      description: Internal Server Error.
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          examples:
            internal_server_error:
              summary: Internal server error
              value:
                code: "INTERNAL_SERVER_ERROR"
                message: "An unexpected error occurred. Please try again later."
                details: null
    
    NotFound:
      description: Not Found - resource does not exist.
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          examples:
            resource_not_found:
              summary: Resource not found
              value:
                code: "RESOURCE_NOT_FOUND"
                message: "The requested resource was not found."
                details: null

    PayloadTooLarge:
      description: Payload Too Large - uploaded file exceeds size limit.
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          examples:
            payload_too_large:
              summary: Uploaded file too large
              value:
                code: "PAYLOAD_TOO_LARGE"
                message: "The uploaded file exceeds the maximum allowed size."
                details: null

    UnsupportedMediaType:
      description: Unsupported Media Type - uploaded file type is not supported.
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          examples:
            unsupported_media_type:
              summary: Uploaded file type not supported
              value:
                code: "UNSUPPORTED_MEDIA_TYPE"
                message: "The uploaded file type is not supported."
                details: null




security:
  - bearerAuth: []




paths:

  # LOGIN
  /session:
    post:
      tags: ["login"]
      summary: logs in the user
      description: |
        If the user does not exist, it will be created,
        and an identifier is returned.
        If the user exists, the user identifier is returned.
      operationId: doLogin
      requestBody:
        description: User details.
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                username:
                  $ref: '#/components/schemas/Username'

              additionalProperties: false
      responses:
        '200':
          description: Login successful.
          content:
            application/json:
              schema:
                type: object
                properties:
                  userId:
                    $ref: '#/components/schemas/UserId'
                additionalProperties: false
        '201':
          description: User created and login successful.
          content:
            application/json:
              schema:
                type: object
                properties:
                  userId:
                    $ref: '#/components/schemas/UserId'
                additionalProperties: false
        '400':
          $ref: '#/components/responses/BadRequest'
        '409':
          $ref: '#/components/responses/Conflict'
        '429':
          $ref: '#/components/responses/TooManyRequests'
        '500':
          $ref: '#/components/responses/InternalError'


  # MANAGE USER PROFILE
  /me/username:
    patch:
      tags: ["user"]
      summary: Sets my username
      description: Sets the authenticated user's username.
      operationId: setMyUserName
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Username'
      responses:
        '200':
          description: Username set successfully.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '409':
          $ref: '#/components/responses/Conflict'
        '500':
          $ref: '#/components/responses/InternalError'

  /me/profile-photo:
    patch:
      tags: ["user"]
      summary: Sets my profile photo URL
      description: Sets the authenticated user's profile photo URL.
      operationId: setMyPhoto
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PhotoUrl'
      responses:
        '200':
          description: Profile photo URL set successfully.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '500':
          $ref: '#/components/responses/InternalError'


  # SEARCH USER BY USERNAME
  /users:
    get:
      tags: ["user"]
      summary: Search users by username.
      description: | 
        Searches for users whose usernames match the provided query.
      operationId: searchUser
      parameters:
        - name: username
          description: The username to search for (full match).
          in: query
          required: true
          schema:
            $ref: '#/components/schemas/Username'
      responses:
        '200':
          description: The user matching the exact username. Null if not found.
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/User'
                nullable: true
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '500':
          $ref: '#/components/responses/InternalError'


  #TODO fare un endpoint che restituisce tutti gli utenti



  # UPLOAD PHOTO
  /me/media/photos:
    post:
      tags: ["media"]
      summary: Upload a photo file.
      description: Uploads a single photo using multipart/form-data and returns its accessible URL.

      operationId: uploadMyPhoto

      requestBody:
        description: The photo file that will be uploaded to the server. Only one file is allowed.
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              description: Container for the uploaded photo file.
              properties:
                file:
                  $ref: '#/components/schemas/Photo'
              additionalProperties: false
              required:
                - file

      responses:
        '201':
          description: Photo uploaded successfully.
          content:
            application/json:
              schema:
                type: object
                description: The response containing the public URL of the uploaded photo.
                properties:
                  photoUrl:
                    type: string
                    description: The URL of the uploaded photo.
                    format: uri
                    minLength: 1
                    maxLength: 1000
                    pattern: "^https?://.+$"
                    example: "https://example.com/photos/abc123.jpg"
                additionalProperties: false
                required:
                  - photoUrl

        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '413':
          $ref: '#/components/responses/PayloadTooLarge'
        '415':
          $ref: '#/components/responses/UnsupportedMediaType'
        '500':
          $ref: '#/components/responses/InternalError'


  # MANAGE MESSAGES
  /messages:
    post:
      tags: ["messages"]
      summary: Send a new message in a conversation
      description: |
        Send a new message (text and/or photo) to the specified conversation.
        The authenticated user (Authorization: Bearer <userId>) is used as senderId.
        The server assigns messageId, createdAt, and the initial status ("sent").
      operationId: sendMessage

      requestBody:
        description: |
          Payload to create a new message in the conversation. `conversationId` and `content` are required.
          The `content` object must contain at least one of the allowed fields (`text` or `photoUrl`).
          `replyTo` can be provided to mark this message as a reply to an existing message.
        required: true
        content:
          application/json:
            schema:
              type: object
              description: Request body to create a message.
              additionalProperties: false
              properties:
                conversationId:
                  description: Id of the conversation where the message is being sent.
                  $ref: '#/components/schemas/ConversationId'
                content:
                  description: The content of the message (text and/or photoUrl). At least one property required.
                  type: object
                  minProperties: 1
                  maxProperties: 2
                  properties:
                    text:
                      description: The textual body of the message.
                      $ref: '#/components/schemas/Text'
                    photoUrl:
                      description: URL referencing a previously uploaded photo to attach to the message.
                      $ref: '#/components/schemas/PhotoUrl'
                  additionalProperties: false
                replyTo:
                  description: Optional messageId of the message being replied to.
                  $ref: '#/components/schemas/MessageId'
                  nullable: true
              required:
                - conversationId
                - content
            examples:
              textOnly:
                summary: Text-only message example
                value:
                  conversationId: "223e4567-e89b-12d3-a456-426614174001"
                  content:
                    text: "Ciao, ci vediamo alle 18?"
              photoOnly:
                summary: Photo-only message example
                value:
                  conversationId: "223e4567-e89b-12d3-a456-426614174001"
                  content:
                    photoUrl: "https://example.com/messages/photos/523e4567-e89b-12d3-a456-426614174010.jpg"
              replyMessage:
                summary: Reply message example
                value:
                  conversationId: "223e4567-e89b-12d3-a456-426614174001"
                  content:
                    text: "Sì, va bene!"
                  replyTo: "323e4567-e89b-12d3-a456-426614174002"

      responses:
        '201':
          description: Message successfully created.
          headers:
            Location:
              description: URL of the created message resource.
              schema:
                type: string
                description: The absolute or relative path to access the newly created message.
                minLength: 1
                maxLength: 1000
                pattern: "^/conversations/.+/messages/.+$"
              example: "/conversations/223e4567-e89b-12d3-a456-426614174001/messages/323e4567-e89b-12d3-a456-426614174002"
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Message'
              examples:
                created:
                  summary: Newly created message
                  value:
                    messageId: "323e4567-e89b-12d3-a456-426614174002"
                    conversationId: "223e4567-e89b-12d3-a456-426614174001"
                    senderId: "123e4567-e89b-12d3-a456-426614174000"
                    createdAt: "2024-01-01T12:00:00Z"
                    content:
                      text: "Ciao, ci vediamo alle 18?"
                    status: "sent"

        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '413':
          $ref: '#/components/responses/PayloadTooLarge'
        '415':
          $ref: '#/components/responses/UnsupportedMediaType'
        '429':
          $ref: '#/components/responses/TooManyRequests'
        '500':
          $ref: '#/components/responses/InternalError'

  /messages/{messageId}:
    delete:
      tags: ["messages"]
      summary: Delete a sent message
      description: |
        Deletes a message previously sent. Only the original sender of the message is allowed to delete it.
        The authenticated user is determined from the Authorization: Bearer <userId> header.
        On success the server returns 204 No Content. The server may implement deletion as a hard delete
        (remove the message permanently) or a soft delete (mark the message as deleted); document the chosen behaviour.
      operationId: deleteMessage

      parameters:
        - name: messageId
          in: path
          description: Identifier of the message to delete.
          required: true
          schema:
            $ref: '#/components/schemas/MessageId'
          example: "323e4567-e89b-12d3-a456-426614174002"

      responses:
        '204':
          description: Message deleted successfully. No content is returned.

        '400':
          $ref: '#/components/responses/BadRequest'

        '401':
          $ref: '#/components/responses/Unauthorized'

        '403':
          $ref: '#/components/responses/Forbidden'

        '404':
          $ref: '#/components/responses/NotFound'

        '500':
          $ref: '#/components/responses/InternalError'

  /messages/{messageId}/forward:
    post:
      tags: ["messages"]
      summary: Forward a message to one or more conversations
      description: |
        Forwards an existing message (identified by {messageId}) to one or more target conversations.
        The authenticated user (Authorization: Bearer &lt;userId&gt;) is used as sender of the new forwarded messages.
        The server will create a new Message resource in each target conversation and return the created messages.
      operationId: forwardMessage

      parameters:
        - name: messageId
          in: path
          required: true
          description: The identifier of the existing message to forward.
          schema:
            $ref: '#/components/schemas/MessageId'

      requestBody:
        required: true
        description: Payload with the list of target conversations where the message will be forwarded.
        content:
          application/json:
            schema:
              properties: 
                targetConversationIds:
                  type: array
                  items:
                    $ref: '#/components/schemas/ConversationId'
                  minItems: 1
                  maxItems: 100
              required: [targetConversationIds]
            examples:
              forward_to_two_conversations:
                summary: Forward to two conversations
                value:
                  targetConversationIds:
                    - "223e4567-e89b-12d3-a456-426614174001"
                    - "223e4567-e89b-12d3-a456-426614174005"

      responses:
        '201':
          description: Forward completed — messages were created in the specified conversations.
          content:
            application/json:
              schema:
                type: object
                description: Result of the forward operation containing created messages.
                properties:
                  createdCount:
                    type: integer
                    description: Number of messages successfully created.
                    minimum: 0
                  createdMessages:
                    description: Array of newly created messages (one per target conversation).
                    type: array
                    minItems: 0
                    maxItems: 100
                    items:
                      $ref: '#/components/schemas/Message'
                additionalProperties: false
                required:
                  - createdCount
                  - createdMessages
              examples:
                forward_result_example:
                  summary: Example forward result
                  value:
                    createdCount: 2
                    createdMessages:
                      - messageId: "523e4567-e89b-12d3-a456-426614174010"
                        conversationId: "223e4567-e89b-12d3-a456-426614174001"
                        senderId: "123e4567-e89b-12d3-a456-426614174000"
                        createdAt: "2024-01-01T12:10:00Z"
                        content:
                          text: "Messaggio inoltrato: Ciao, ci vediamo alle 18?"
                        status: "sent"
                      - messageId: "523e4567-e89b-12d3-a456-426614174011"
                        conversationId: "223e4567-e89b-12d3-a456-426614174005"
                        senderId: "123e4567-e89b-12d3-a456-426614174000"
                        createdAt: "2024-01-01T12:10:01Z"
                        content:
                          text: "Messaggio inoltrato: Ciao, ci vediamo alle 18?"
                        status: "sent"

        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          $ref: '#/components/responses/Conflict'
        '413':
          $ref: '#/components/responses/PayloadTooLarge'
        '415':
          $ref: '#/components/responses/UnsupportedMediaType'
        '429':
          $ref: '#/components/responses/TooManyRequests'
        '500':
          $ref: '#/components/responses/InternalError'


  # MANAGE REACTIONS
  /reactions:
    post:
      tags: ["reactions"]
      summary: Add (comment) a reaction to a message
      description: |
        Adds a reaction (emoji) to the specified message. The authenticated user (Authorization: Bearer <userId>)
        will be recorded as the reactor. The server assigns reactionId and reactedAt. If the same user previously
        reacted with the same emoji, server behaviour may be to return 409 Conflict or to return the existing reaction;
        this behaviour should be documented in the implementation notes.
      operationId: commentMessage

      requestBody:
        description: Request containing the messageId and the emoji to add as reaction.
        required: true
        content:
          application/json:
            schema:
              type: object
              description: The reaction payload. Both `messageId` and `emoji` are required.
              properties:
                messageId:
                  $ref: '#/components/schemas/MessageId'
                  description: Identifier of the message to which the reaction will be attached.
                emoji:
                  $ref: '#/components/schemas/Emoji'
                  description: The emoji used for the reaction.
              required:
                - messageId
                - emoji
              additionalProperties: false
            examples:
              thumbs_up:
                summary: Thumbs up example
                value:
                  messageId: "323e4567-e89b-12d3-a456-426614174002"
                  emoji: "1F44D"

      responses:
        '201':
          description: Reaction created successfully.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Reaction'
              examples:
                created_reaction:
                  summary: Newly created reaction
                  value:
                    reactionId: "423e4567-e89b-12d3-a456-426614174003"
                    messageId: "323e4567-e89b-12d3-a456-426614174002"
                    userId: "123e4567-e89b-12d3-a456-426614174000"
                    emoji: "1F44D"
                    reactedAt: "2024-01-01T12:02:00Z"

        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          $ref: '#/components/responses/Conflict'
        '429':
          $ref: '#/components/responses/TooManyRequests'
        '500':
          $ref: '#/components/responses/InternalError'

  /reactions/{reactionId}:
    delete:
      tags: ["reactions"]
      summary: Remove (uncomment) a reaction
      description: |
        Removes an existing reaction identified by {reactionId}. Only the user who created the reaction
        (the reactor) is allowed to delete it. The authenticated user is determined from the Authorization header.
        On success the server returns 204 No Content.
      operationId: uncommentMessage

      parameters:
        - name: reactionId
          in: path
          description: Identifier of the reaction to remove.
          required: true
          schema:
            $ref: '#/components/schemas/ReactionId'
          example: "423e4567-e89b-12d3-a456-426614174003"

      responses:
        '204':
          description: Reaction removed successfully. No content is returned.

        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'


  # MANAGE GROUPS
  /groups/{groupId}/name:
    put:
      tags: ["groups"]
      summary: Set the name of a group
      description: |
        Updates the name of the specified group.
        The authenticated user must be a member of the group and must have permission to modify its settings.

      operationId: setGroupName

      parameters:
        - name: groupId
          in: path
          required: true
          description: The ID of the group whose name will be updated.
          schema:
            $ref: '#/components/schemas/ConversationId'

      requestBody:
        required: true
        description: Payload containing the new group name.
        content:
          application/json:
            schema:
              type: object
              description: Object containing the new group name to assign.
              properties:
                name:
                  $ref: '#/components/schemas/GroupName'
              required:
                - name
              additionalProperties: false

      responses:
        '200':
          description: Group name updated successfully.
          content:
            application/json:
              schema:
                type: object
                description: The updated group resource.
                properties:
                  groupId:
                    $ref: '#/components/schemas/ConversationId'
                  name:
                    type: string
                    description: The updated name of the group.
                    minLength: 1
                    maxLength: 100
                    pattern: "^[A-Za-z0-9 _\\-]+$"
                    example: "My Awesome Group"
                required:
                  - groupId
                  - name
                additionalProperties: false

        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          $ref: '#/components/responses/Conflict'
        '429':
          $ref: '#/components/responses/TooManyRequests'
        '500':
          $ref: '#/components/responses/InternalError'

  /groups/{groupId}/photos:
    post:
      tags: ["groups"]
      summary: Upload a photo for a group
      description: |
        Uploads a photo file for the specified group and returns a public URL (photoUrl).
        The authenticated user must be a member of the group and have permission to upload group media.
        The client should then call PUT /groups/{groupId}/photo with the returned photoUrl to set the group's photo.
      operationId: uploadGroupPhoto

      parameters:
        - name: groupId
          in: path
          required: true
          description: Identifier of the group that will own the uploaded photo.
          schema:
            $ref: '#/components/schemas/ConversationId'

      requestBody:
        description: The photo file to upload. Use multipart/form-data with a single `file` field.
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              description: Container for the uploaded photo file.
              properties:
                file:
                  $ref: '#/components/schemas/Photo'
              required:
                - file
              additionalProperties: false

      responses:
        '201':
          description: Photo uploaded successfully — returns the public URL of the uploaded photo.
          content:
            application/json:
              schema:
                type: object
                description: Response containing the URL of the uploaded photo.
                properties:
                  photoUrl:
                    $ref: '#/components/schemas/PhotoUrl'
                additionalProperties: false
                required:
                  - photoUrl
              examples:
                uploaded:
                  summary: Uploaded photo result
                  value:
                    photoUrl: "https://example.com/groups/photos/523e4567-e89b-12d3-a456-426614174010.jpg"

        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '413':
          $ref: '#/components/responses/PayloadTooLarge'
        '415':
          $ref: '#/components/responses/UnsupportedMediaType'
        '500':
          $ref: '#/components/responses/InternalError'

  /groups/{groupId}/group-photo:
    put:
      tags: ["groups"]
      summary: Set the group's photo using an existing URL
      description: |
        Sets the group's profile photo to the provided `photoUrl`. The URL must be reachable and point to a supported image.
        The authenticated user must be a member of the group and have permission to modify group settings.
        Typical flow: 1) POST /groups/{groupId}/photos (upload) -> receive photoUrl; 2) PUT /groups/{groupId}/photo with that photoUrl.
      operationId: setGroupPhoto

      parameters:
        - name: groupId
          in: path
          required: true
          description: Identifier of the group whose photo will be set.
          schema:
            $ref: '#/components/schemas/ConversationId'

      requestBody:
        description: JSON payload containing the `photoUrl` previously obtained from the upload endpoint.
        required: true
        content:
          application/json:
            schema:
              type: object
              description: Payload to set the group's photo using an existing URL.
              properties:
                photoUrl:
                  $ref: '#/components/schemas/PhotoUrl'
              additionalProperties: false 
              required:
                - photoUrl
            examples:
              set_by_url:
                summary: Set group photo using an uploaded URL
                value:
                  photoUrl: "https://example.com/groups/photos/523e4567-e89b-12d3-a456-426614174010.jpg"

      responses:
        '200':
          description: Group photo updated successfully; returns the updated group resource.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Group'
              examples:
                updated_group:
                  summary: Updated group with new photoUrl
                  value:
                    conversationId: "223e4567-e89b-12d3-a456-426614174001"
                    name: "Family Group"
                    photoUrl: "https://example.com/groups/photos/523e4567-e89b-12d3-a456-426614174010.jpg"
                    memberIds:
                      - "123e4567-e89b-12d3-a456-426614174000"
                      - "423e4567-e89b-12d3-a456-426614174009"

        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '415':
          $ref: '#/components/responses/UnsupportedMediaType'
        '500':
          $ref: '#/components/responses/InternalError'

  /groups/{groupId}/members:
    post:
      tags: ["groups"]
      summary: Add one or more users to a group
      description: |
        Adds the specified users to the group identified by {groupId}.
        The authenticated user (Authorization: Bearer <userId>) must be a member of the group and
        must have permission to add new members. The server will add each user in `memberIds`
        to the group; if some users are already members, server may ignore them or return 409 for conflicts.
      operationId: addToGroup

      parameters:
        - name: groupId
          in: path
          required: true
          description: Identifier of the group to which users will be added.
          schema:
            $ref: '#/components/schemas/ConversationId'

      requestBody:
        description: JSON payload containing the list of user IDs to add to the group.
        required: true
        content:
          application/json:
            schema:
              type: object
              description: Payload with member IDs to add to the group.
              properties:
                memberIds:
                  description: Array of user IDs to add to the group.
                  type: array
                  minItems: 1
                  maxItems: 1000
                  items:
                    $ref: '#/components/schemas/UserId'
              additionalProperties: false
              required:
                - memberIds
            examples:
              add_two_members:
                summary: Add two users to the group
                value:
                  memberIds:
                    - "123e4567-e89b-12d3-a456-426614174000"
                    - "423e4567-e89b-12d3-a456-426614174009"

      responses:
        '200':
          description: Users added successfully — returns the updated group resource.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Group'
              examples:
                updated_group:
                  summary: Group after adding members
                  value:
                    conversationId: "223e4567-e89b-12d3-a456-426614174001"
                    name: "Family Group"
                    photoUrl: "https://example.com/groups/photos/523e4567-e89b-12d3-a456-426614174010.jpg"
                    memberIds:
                      - "123e4567-e89b-12d3-a456-426614174000"
                      - "423e4567-e89b-12d3-a456-426614174009"
                      - "323e4567-e89b-12d3-a456-426614174002"

        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          $ref: '#/components/responses/Conflict'
        '429':
          $ref: '#/components/responses/TooManyRequests'
        '500':
          $ref: '#/components/responses/InternalError'

  /groups/{groupId}/leave:
    post:
      tags: ["groups"]
      summary: Leave a group
      description: |
        The authenticated user (Authorization: Bearer <userId>) leaves the specified group.
        After this call the user will no longer receive messages from the group and will not be listed
        among its members. If the user is the last admin or if other business rules prevent leaving,
        the server should return an appropriate error (403 or 409).
      operationId: leaveGroup

      parameters:
        - name: groupId
          in: path
          required: true
          description: Identifier of the group the authenticated user will leave.
          schema:
            $ref: '#/components/schemas/ConversationId'

      requestBody:
        description: Optional JSON payload with leave options (currently unused). Clients may omit this body.
        required: false
        content:
          application/json:
            schema:
              type: object
              description: Reserved for future leave options (e.g., transfer-admin:true).
              properties:
                transferAdminTo:
                  description: Optional userId to transfer admin rights before leaving.
                  $ref: '#/components/schemas/UserId'
              additionalProperties: false
            examples:
              leave_simple:
                summary: Simple leave (no body)
                value: {}

      responses:
        '204':
          description: Left the group successfully. No content is returned.

        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          $ref: '#/components/responses/Conflict'
        '500':
          $ref: '#/components/responses/InternalError'


  # SHOW CONVERSATIONS
  /me/conversations:
    get:
      tags: ["conversations"]
      summary: Get my conversations
      description: |
        Returns all conversations where the authenticated user is a participant.
        The authenticated user is extracted from the Authorization: Bearer <userId> header.
        The server returns the list of conversations sorted by most recent activity.

      operationId: getMyConversations

      responses:
        '200':
          description: List of conversations the user participates in.
          content:
            application/json:
              schema:
                type: array
                description: Array of conversations associated with the authenticated user.
                items:
                  $ref: '#/components/schemas/Conversation'
                minItems: 0
                maxItems: 10000
              examples:
                sample:
                  summary: Example of conversation list
                  value:
                    - conversationId: "223e4567-e89b-12d3-a456-426614174001"
                      name: "Gruppo Amici"
                      type: "group"
                      createdAt: "2024-01-01T10:00:00Z"
                    - conversationId: "123e4567-e89b-12d3-a456-426614174099"
                      name: "Chat privata"
                      type: "private"
                      createdAt: "2024-01-02T08:00:00Z"

        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '429':
          $ref: '#/components/responses/TooManyRequests'
        '500':
          $ref: '#/components/responses/InternalError'

  # SHOW ONE CONVERSATION
  /conversations/{conversationId}:
    get:
      tags: ["conversations"]
      summary: Get a conversation and its messages
      description: |
        Returns the specified conversation (chat or group) and a page of messages exchanged in it.
        Messages are returned in reverse chronological order (newest first) by default.
        The authenticated user (Authorization: Bearer <userId>) must be a participant of the conversation.
        Use `limit` and `before`/`after` to page through messages.

      operationId: getConversation

      parameters:
        - name: conversationId
          in: path
          required: true
          description: Identifier of the conversation to retrieve.
          schema:
            $ref: '#/components/schemas/ConversationId'
          example: "223e4567-e89b-12d3-a456-426614174001"

        - name: limit
          in: query
          required: false
          description: Maximum number of messages to return in the page (1..100).
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 30
          example: 30

        - name: offset
          description: "The number of items to skip before starting to collect the result set (used for pagination)."
          in: query
          required: false
          schema:
            description: "The number of items to skip before starting to collect the result set (used for pagination)."
            type: integer
            minimum: 0
            default: 0

      responses:
        '200':
          description: Conversation retrieved successfully with a page of messages.
          content:
            application/json:
              schema:
                type: object
                description: Conversation details and a page of messages (newest first by default).
                properties:
                  conversation:
                    $ref: '#/components/schemas/Conversation'
                  messages:
                    type: array
                    description: Page of messages (reverse chronological by default).
                    items:
                      $ref: '#/components/schemas/Message'
                    minItems: 0
                    maxItems: 100
                  hasMore:
                    type: boolean
                    description: True if there are older messages available beyond this page.
                    example: false
                  nextCursor:
                    type: string
                    description: Cursor value (timestamp) to fetch the next page (use as `before`).
                    minLength: 0
                    maxLength: 1000
                    pattern: "^.*$"
                    example: "2024-01-01T11:59:59Z"
                additionalProperties: false
                required:
                  - conversation
                  - messages
              examples:
                convo_with_messages:
                  summary: Conversation with two messages
                  value:
                    conversation:
                      conversationId: "223e4567-e89b-12d3-a456-426614174001"
                      name: "Family Group"
                      photoUrl: "https://example.com/groups/photos/523e4567-e89b-12d3-a456-426614174010.jpg"
                      memberIds:
                        - "123e4567-e89b-12d3-a456-426614174000"
                        - "423e4567-e89b-12d3-a456-426614174009"
                    messages:
                      - messageId: "623e4567-e89b-12d3-a456-426614174020"
                        conversationId: "223e4567-e89b-12d3-a456-426614174001"
                        senderId: "123e4567-e89b-12d3-a456-426614174000"
                        createdAt: "2024-01-02T15:00:00Z"
                        content:
                          text: "Ci vediamo stasera?"
                        status: "sent"
                      - messageId: "523e4567-e89b-12d3-a456-426614174010"
                        conversationId: "223e4567-e89b-12d3-a456-426614174001"
                        senderId: "423e4567-e89b-12d3-a456-426614174009"
                        createdAt: "2024-01-02T14:59:00Z"
                        content:
                          text: "Sì, a che ora?"
                        status: "read"
                    hasMore: true
                    nextCursor: "2024-01-02T14:59:00Z"

        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '429':
          $ref: '#/components/responses/TooManyRequests'
        '500':
          $ref: '#/components/responses/InternalError'
